<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.first_name }} {{ user.last_name }}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Kaffeeliste">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/entries.css') }}" rel="stylesheet">
</head>
<body>
    
    <div class="container">
        <div class="main-container">
            <!-- List with all beverages. To add and remove beverages and a count to already consumed beverages. -->
            <!-- Beverage_name price-single, count, add button - field - remove button -->
            <!-- Can only remove just added beverages and not the ones that were already consumed. -->
            <!-- At the bottom a button to confirm the order and a button to cancel the order.
             If pressed the order is confirmed and the page is redirected to the index page.
             Beverages are now written to the database fixed and added to the invoice.
             If first beverage consumption of month:
             1. invoice created for current month
             2. beverage added to invoice of current month
             else:
             1. beverage added to invoice of current month -->

            <div class="row">
                <div class="col-12">
                    <div class="user-info-card">
                        {% if user.id == 0 %}
                        <!-- Guest user - show name and role centered, no PIN management -->
                        <div class="pin-management-section">
                            <h4 class="user-info-title-no-pin">{{ user.first_name }} {{ user.last_name }}</h4>
                            <div class="role-and-pin-container">
                                <span class="user-role-badge-unified">{{ user.role.name if user.role else 'No Role' }}</span>
                            </div>
                        </div>
                        {% elif user.pin_hash %}
                        <!-- User with PIN - show name and role centered, change PIN button on the right -->
                        <div class="user-info-header">
                            <div class="user-info-main">
                                <h4 class="user-info-title">{{ user.first_name }} {{ user.last_name }}</h4>
                                <span class="user-role-badge-unified">{{ user.role.name if user.role else 'No Role' }}</span>
                            </div>
                            <div class="user-info-actions">
                                <button id="changePinBtn" class="btn btn-outline-secondary btn-sm change-pin-btn" title="Change PIN">
                                    <i class="fas fa-key"></i>
                                    Change PIN
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <!-- User without PIN - show name, role and create PIN button centered -->
                        <div class="pin-management-section">
                            <h4 class="user-info-title-no-pin">{{ user.first_name }} {{ user.last_name }}</h4>
                            <div class="role-and-pin-container">
                                <span class="user-role-badge-unified">{{ user.role.name if user.role else 'No Role' }}</span>
                                <button id="createPinBtn" class="btn btn-success pin-management-btn">
                                    <i class="fas fa-plus"></i>
                                    Create PIN
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Selection Interface Container -->
            <div class="selection-container">
                <!-- Beverage Consumption Interface -->
                <div class="beverage-section">
                    <h5 class="section-title">
                        <i class="fas fa-coffee"></i>
                        Beverage Selection
                    </h5>
                    
                    <div class="beverage-list">
                        {% for beverage in beverages %}
                            {% if beverage.category == 'drink' %}
                                {% set price_info = price_lookup.get(beverage.id) %}
                                <div class="beverage-item" data-beverage-id="{{ beverage.id }}">
                                    <div class="consumed-count-section">
                                        <span class="consumed-count">0</span>
                                        <small class="consumed-label">consumed</small>
                                    </div>
                                    
                                    <div class="beverage-info">
                                        <h6 class="beverage-name">{{ beverage.name }}</h6>
                                        {% if price_info %}
                                            <span class="beverage-price">{{ "%.2f"|format(price_info.price_cents / 100) }} €</span>
                                        {% else %}
                                            <span class="beverage-price text-warning">No price set</span>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="beverage-controls">
                                        {% if price_info %}
                                            <div class="quantity-controls">
                                                <button class="btn btn-outline-secondary quantity-btn" data-action="decrease">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <span class="quantity-display">0</span>
                                                <button class="btn btn-outline-secondary quantity-btn" data-action="increase">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        {% else %}
                                            <div class="quantity-controls">
                                                <button class="btn btn-outline-secondary quantity-btn" disabled title="No price set for this item">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <span class="quantity-display">0</span>
                                                <button class="btn btn-outline-secondary quantity-btn" disabled title="No price set for this item">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>

            </div>


            <!-- Action Buttons -->
            <div class="action-buttons-section">
                <button class="btn btn-primary btn-lg done-btn" id="doneBtn">
                    <i class="fas fa-check"></i>
                    Done
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">
                        <i class="fas fa-shopping-cart"></i>
                        Confirm Order
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="order-summary-modal">
                        <h6>Order Summary:</h6>
                        <div id="modalOrderItems"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" id="confirmOrderBtn">
                        <i class="fas fa-check"></i>
                        Confirm Order
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PIN Creation Overlay -->
    <div id="pinOverlay" class="pin-overlay" style="display: none;">
        <div class="pin-modal">
            <div class="pin-header">
                <h4><i class="fas fa-key"></i> Create PIN</h4>
                <p id="pinUserInfo">Please enter a new PIN for {{ user.first_name }} {{ user.last_name }}</p>
            </div>
            <div class="pin-body">
                <div class="pin-input-container">
                    <input type="password" id="pinInput" class="pin-input" placeholder="Enter 4-digit PIN" maxlength="4" autocomplete="off" pattern="[0-9]{4}">
                    <button type="button" id="pinSubmit" class="pin-submit-btn">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
                <div id="pinError" class="pin-error" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Error creating PIN. Please try again.</span>
                </div>
                <div class="pin-actions">
                    <button type="button" id="pinCancel" class="pin-cancel-btn">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pass backend data to JavaScript -->
    <script>
        // Pass consumptions data to JavaScript
        window.consumptionsData = {{ consumptions | tojson }};
        window.userData = {{ user_data | tojson }};
        window.userId = {{ user.id }};
    </script>
    
    <!-- External JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/entries.js') }}"></script>
    
    <!-- Theme Switcher for Entries -->
    <script>
        // Theme Switcher Class for Entries
        class ThemeSwitcher {
            constructor() {
                this.currentTheme = localStorage.getItem('selectedTheme') || 'coffee';
                this.init();
            }

            init() {
                // Set initial theme
                this.applyTheme(this.currentTheme);
                
                // Listen for theme changes from other tabs/windows
                window.addEventListener('storage', (e) => {
                    if (e.key === 'selectedTheme' && e.newValue) {
                        this.currentTheme = e.newValue;
                        this.applyTheme(e.newValue);
                        console.log(`Entries view: Theme changed via storage to ${e.newValue}`);
                    }
                });
                
                // Listen for custom theme change events
                window.addEventListener('themeChanged', (e) => {
                    this.currentTheme = e.detail.theme;
                    this.applyTheme(e.detail.theme);
                    console.log(`Entries view: Theme changed via custom event to ${e.detail.theme}`);
                });
                
                // Listen for postMessage from other windows
                window.addEventListener('message', (e) => {
                    if (e.data && e.data.type === 'themeChange') {
                        this.currentTheme = e.data.theme;
                        this.applyTheme(e.data.theme);
                        console.log(`Entries view: Theme changed via postMessage to ${e.data.theme}`);
                    }
                });
                
                // Also check for theme changes on focus (when user switches back to tab)
                window.addEventListener('focus', () => {
                    const storedTheme = localStorage.getItem('selectedTheme') || 'coffee';
                    if (storedTheme !== this.currentTheme) {
                        this.currentTheme = storedTheme;
                        this.applyTheme(storedTheme);
                        console.log(`Entries view: Theme changed via focus to ${storedTheme}`);
                    }
                });
                
                // Poll for theme changes every 500ms as a fallback
                setInterval(() => {
                    const storedTheme = localStorage.getItem('selectedTheme') || 'coffee';
                    if (storedTheme !== this.currentTheme) {
                        this.currentTheme = storedTheme;
                        this.applyTheme(storedTheme);
                        console.log(`🔄 Entries view: Theme changed via polling to ${storedTheme}`);
                    }
                }, 500);
                
                // AGGRESSIVE: Poll server for theme changes every 1 second
                setInterval(() => {
                    fetch('/api/get-theme')
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.theme !== this.currentTheme) {
                                this.currentTheme = data.theme;
                                localStorage.setItem('selectedTheme', data.theme);
                                this.applyTheme(data.theme);
                                console.log(`🌐 Entries view: Theme changed via server polling to ${data.theme}`);
                            }
                        })
                        .catch(err => console.log('Server theme polling failed:', err));
                }, 1000);
            }

            applyTheme(theme) {
                // Force theme application with multiple methods
                document.body.setAttribute('data-theme', theme);
                
                // Also set it as a class for additional CSS targeting
                document.body.className = document.body.className.replace(/theme-\w+/g, '');
                document.body.classList.add(`theme-${theme}`);
                
                // Force a style recalculation
                document.body.style.display = 'none';
                document.body.offsetHeight; // Trigger reflow
                document.body.style.display = '';
                
                // Debug log
                console.log(`Theme applied to entries: ${theme}`);
            }
        }

        // Initialize theme when page loads
        document.addEventListener('DOMContentLoaded', function() {
            new ThemeSwitcher();
        });
    </script>
</body>
</html>
